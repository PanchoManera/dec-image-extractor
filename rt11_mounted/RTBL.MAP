
.IFF
	MOV	R4,R2
	MOV	@R4,R4
	BIT	#NORUN$,I.BLOK(R4)
	BNE	25$
	MOV	R5,R3
	MOV	ERPTR,R5
	BR	JBACTV
25$:	CLR	@R2
	MOV	R5,-(SP)
.ENDC
.IF NE	ERL$G
.IF NE	SYT$K
	CMP	#"EL,I.LNAM(R4)
	BNE	17$
	TSTB	I.LNAM+2(R4)
	BNE	17$
.IFF
	CMP	#<^REL >,I.NAME+2(R4)
	BNE	17$
.ENDC
	MOV	@#SYSPTR,R5
	CLR	$ELHND-$RMON(R5)
17$:
.ENDC
	OJSR	PC,PUTBLK
	BCC	18$
	ADD	R0,2(SP)
	ADD	R0,@SP
18$:
.IF NE	SYT$K
	MOV	#MXJBNM,R3
	MOV	@#SYSPTR,R5
	ADD	#<$IMPUR-$RMON+MXJBNM+2>,R5
19$:	TST	-(R5)
	BNE	11$
	SUB	#2,R3
	BNE	19$
	BIC	#FJOB$,<CONFIG-$IMPUR-2>(R5)
.ENDC
	BR	11$
.ENDC
.DSABL	LSB
UNPRO:
.IF NE	BF
	MOV	R5,-(SP)
	CLR	-(SP)
	.UNPROT	SP
	CMP	(SP)+,(SP)+
.ENDC
	CLR	(R5)+
	CLR	@R5
	RTS	PC
.ENDC
.IF NE	SYT$K
.ENABL	LSB
CKLJN::	MOV	R5,(PC)+
R5STRT:	 .WORD	0
	ADDR	NBUFF+6,R0
	CLR	-(R0)
	CLR	-(R0)
	CLR	-(R0)
	MOV	R0,-(SP)
	MOV	#6,R1
	TSTB	-(R5)
	BNE	2$
	OJMP	BADCOM
1$:	TSTB	-(R5)
	BEQ	3$
	CMPB	#COMMA,@R5
	BEQ	3$
2$:	MOVB	@R5,(R0)+
	DEC	R1
	BNE	1$
	DEC	R5
	MOV	R5,R3
3$:	MOV	(SP)+,R0
	MOV	R5,-(SP)
	MOV	@#SYSPTR,R5
	ADD	#$IMPUR-$RMON,R5
	MOV	R5,(PC)+
SVISTA:	 .WORD	0
	CLR	R4
	JSR	PC,FNDJOB-$IMPUR(R5)
	BEQ	4$
	MOV	R5,R4
	SUB	SVISTA,R5
	MOV	R5,R3
	BR	5$
4$:	MOV	R5STRT,@SP
5$:	MOV	(SP)+,R5
	TST	R4
	RTS	PC
NBUFF:	.BLKW	3
JBACTV:	MOV	R5,R4
	CLRB	@R3
	KMRTMG	<Job active - cannot unload >,,<BCKASZ>
NOSJB:	MOV	R5,R4
	CLRB	@R3
	KMRTMG	<No such job - >,,<BCKASZ>
.DSABL	LSB
OWNRUN:	MOV	R2,-(SP)
	MOV	R5,-(SP)
	MOV	#4,R2
1$:	MOVB	@R3,R5
	JSR	PC,3$
	MOVB	(R3)+,R5
	ASRB	R5
	ASRB	R5
	ASRB	R5
	ASRB	R5
	JSR	PC,3$
	DEC	R2
	BNE	1$
	CMP	-(R3),-(R3)
	MOV	(SP)+,R5
	MOV	(SP)+,R2
2$:	RTS	PC
3$:	BIT	#1,R5
	BEQ	2$
	BIC	#^C<16>,R5
	BEQ	2$
	ADD	@#SYSPTR,R5
	MOV	$IMPUR-$RMON(R5),R5
	BEQ	2$
	BIT	#NORUN$,I.BLOK(R5)
	BNE	2$
	KMRTMG	<Job active - cannot unload>
.ENDC
.IF NE	FRUN$$!SRUN$$
.SBTTL	FRUN/SRUN PART 1
	OVERLAY
	SYNTAX	SRUN
	PROMPT	$FILE
	SCALL	GSWIT,<1>
	REQBLNK
	ROUTINE	FSP
	SCALL	RINSPC,<1>
	END
 SWITS	SRUN
 ENDNO
SWIT	PAUSE		1	-	-	PAU
SWIT	TERMINAL	1	-	-	TTY
SWIT	BUFFER		1	-	-	BUF
SWIT	NAME		1	-	-	NAM
SWIT	LEVEL		1	-	-	LEV
 NOS
 ENDS
STA	= 40
STK	= 42
RSZ	= 52
FRJSTK	= 54
OSZ	= 56
RID	= 60
RBD	= 62
FJOBNM	= FJOBS*2
MXJBNM	= FJOBNM
OFLEV	= FSIZ
OFPSW	= OFLEV+2
OFLJN	= OFPSW+2
OFBUF	= OFLJN+6
OFTTY	= OFBUF+2
OFTCB	= OFTTY+2
.ENABL	LSB
.IF NE	FRUN$$
	OVCMD	FRUN
	MOV	#FJOBNM,(PC)+
.ENDC
JLVL:	 .WORD	0
.IF NE	SYT$K
	BR	FSRUN
.IF NE	SRUN$$
	OVCMD	SRUN
	CLR	JLVL
.ENDC
.ENDC
FSRUN:	MOV	#FSIZ,R2
	OADDR	FILST+OFLEV,R3
.IF NE	SYT$K
	MOV	R3,-(SP)
.ENDC
1$:	CLR	(R3)+
	DEC	R2
	BNE	1$
	ITBLE	1
	OJSR	PC,INITIT
	MOV	@#SYSPTR,R5
.IF NE	SYT$K
	MOV	(SP)+,R0
	ADD	#OFLJN-OFLEV,R0
	TST	@R0
	BNE	2$
	SUB	#FSIZ,R0
2$:	JSR	PC,FNDJOB-$RMON(R5)
	BEQ	3$
	BIT	#NORUN$,I.BLOK(R2)
	BEQ	BADNAM
	JSR	PC,DEADJB
3$:	MOV	@#SYSPTR,R5
	MOV	JLVL,R3
	BNE	5$
	MOV	#MXJBNM,R3
	ADD	#<$IMPUR-$RMON+MXJBNM>,R5
4$:	SUB	#2,R3
	BEQ	MAXACT
	TST	-(R5)
	BEQ	7$
	MOV	@R5,R2
	BIT	#NORUN$,I.BLOK(R2)
	BNE	6$
	BR	4$
5$:	ADD	R3,R5
	ADD	#<$IMPUR-$RMON>,R5
.IFF
	MOV	#FJOBNM,R3
	ADD	#<FCNTXT-$RMON>,R5
.ENDC
	TST	@R5
	BEQ	7$
	MOV	@R5,R2
	BIT	#NORUN$,I.BLOK(R2)
	BNE	6$
.IF NE	SYT$K
	CMP	#FJOBNM,R3
	BNE	BADLVL
.ENDC
	KMEROR	<Foreground active>
6$:	JSR	PC,DEADJB
7$:	MOV	R5SAV,R5
	MOV	R3,-(SP)
..FRDK	== .+2
	MOV	#<^RDK >,R3
.IF NE	SYT$K
	CMP	#FJOBNM,@SP
	BEQ	8$
..SRDK	== .+2
	MOV	#<^RDK >,R3
	OJSR	PC,SFILE
	BR	9$
8$:
.ENDC
	OJSR	PC,RFILE
9$:	OADDR	FILST+OFLEV,R4
	MOV	(SP)+,@R4
.IF NE	MTT$Y
	ADD	#OFTTY-OFLEV,R4
	MOV	(R4)+,R2
	MOV	@#SYSPTR,R0
	MOV	BKCNSL-$RMON(R0),@R4
	MOV	(R4)+,@R4
	TST	R2
	BEQ	10$
	COM	R2
	ADD	#TCBLST-$RMON,R0
	ADD	R2,R0
	MOV	@R0,R0
	BEQ	ILLUN
	TST	T.CSR(R0)
	BEQ	ILLUN
	TST	T.OWNR(R0)
	BNE	ILLUN
	BIT	#CONSL$,T.STAT(R0)
	BNE	ILLUN
	MOV	R0,@R4
10$:
.ENDC
	MOV	R5SAV,R5
	MOV	R3,R0
	OJMP	FSGHAR
OVCMD	FSR2
	MOV	(SP)+,R0
	OJSR	PC,COPYFN
	.LOOKUP	CHOVLY
	BCC	11$
	OJMP	NOTFND
11$:
 OINST	CLR	@.BLKEY,,*
	OVLINK	FSRU2
BDCMND: OJMP	BADCOM
ILLUN:	KMEROR	<Illegal terminal>
.IF NE	SYT$K
BADNAM:	KMEROR	<Illegal logical job name>
BADLVL:	KMEROR	<Illegal priority level>
MAXACT:	KMEROR	<Six system tasks already running - cannot SRUN task>
.ENDC
.DSABL	LSB
.SBTTL	FRUN/SRUN PART 3
.ENABL	LSB
	OVCMD	STRTPG
	MOV	(SP)+,R4
	MOV	@#SYSPTR,R3
.IF NE	MTT$Y
	OADDR	FILST+OFTTY,R2
	MOV	(R2)+,R1
	BEQ	1$
	COM	R1
	ASR	R1
	BR	2$
1$:	MOV	BKGND+I.CLUN-$RMON(R3),R1
2$:	MOV	R1,I.CLUN(R4)
	MOV	(R2)+,R0
	MOV	@R2,R1
	MOV	R1,I.CNSL(R4)
	CMP	R0,R1
	BEQ	3$
	BIS	#CONSL$,T.STAT(R1)
	MOV	R4,T.OWNR(R1)
.IF NE	SYT$K
	DEC	T.CNT(R0)
	CMP	#1,T.CNT(R0)
	BNE	3$
.ENDC
	MOV	BCNTXT-$RMON(R3),T.OWNR(R0)
	BIC	#SHARE$,T.STAT(R0)
3$:	BIC	#^C<TTSPC$!TTLC$!TCBIT$>,I.TERM(R4)
	BIC	#<TTSPC$!TTLC$!TCBIT$>,@R1
	BIS	@R1,I.TERM(R4)
.ENDC
	BIS	#FJOB$,CONFIG-$RMON(R3)
	MOV	R3,R2
	MOV	(SP)+,R5
	ADD	R5,R2
	ASL	R5
	ADD	R5,R3
	MOV	(SP)+,$JBLIM+2-$RMON(R3)
	MOV	(SP)+,$JBLIM-$RMON(R3)
	MOV	R4,R3
	ADD	#I.JID,R3
	MOV	(PC)+,(R3)+
	 .ASCII	<CR><LF>
.IF NE	SYT$K
	OADDR	FILST+OFLEV,R5
	MOV	@R5,R1
	ADD	#OFLJN-OFLEV,R5
	TST	@R5
	BNE	4$
	SUB	#FSIZ,R5
4$:	MOV	R5,-(SP)
	CMP	#FJOBNM,R1
	BEQ	7$
	MOV	#6,R1
5$:	MOVB	(R5)+,(R3)+
	TSTB	@R5
	BEQ	6$
	DEC	R1
	BNE	5$
6$:	MOVB	#'>,(R3)+
	MOVB	#CR,(R3)+
	MOVB	#LF,(R3)+
	CLRB	@R3
	BR	8$
7$:
.ENDC
	MOV	(PC)+,(R3)+
	 .ASCII	"F>"
	MOV	(PC)+,(R3)+
	 .ASCII	<CR><LF>
	CLR	@R3
.IF NE	SYT$K
8$:	MOV	(SP)+,R5
	MOV	R4,R3
	ADD	#I.LNAM,R3
	MOV	(R5)+,(R3)+
	MOV	(R5)+,(R3)+
	MOV	(R5)+,(R3)+
.ENDC
	MOV	@#SYSPTR,R3
	MOV	(SP)+,R1
	BIT	#WINDW$,@R4
	BEQ	9$
	MOV	R3,SYSPTR(R1)
	TST	V.EMT(R1)
	BNE	9$
	MOV	@#V.EMT,V.EMT(R1)
9$:	TST	(SP)+
	BNE	10$
	MOV	R4,$IMPUR-$RMON(R2)
	CLR	@<.EXTFL-OVLY>-<.+4-OVLYST>(PC)
.IF NE	ERL$G
	JSR	PC,ERLOAD
.ENDC
	MOVB	#MXJBNM/2+200,INTACT-$RMON(R3)
	.EXIT
10$:	BIS	#KSPND$,I.BLOK(R4)
	MOV	R4,$IMPUR-$RMON(R2)
	CLR	@<.EXTFL-OVLY>-<.+4-OVLYST>(PC)
.IF NE	ERL$G
	JSR	PC,ERLOAD
.ENDC
	JSR	R0,11$
.NLIST	BEX
	 .ASCII	"Loaded at "<200>
.LIST	BEX
	.EVEN
11$:	TST	(SP)+
	.PRINT
	MOV	#30,R0
	SEC
12$:	ROL	R1
	ROLB	R0
	.TTYOUT
	MOV	#206,R0
13$:	ASL	R1
	BEQ	14$
	ROLB	R0
	BCS	13$
	BR	12$
14$:	OJMP	KCRLF
.DSABL	LSB
.IF NE	ERL$G
ERLOAD:	CALL	ERLCHK
	BNE	1$
	MOV	R4,$ELIMP-$RMON(R3)
	MOV	@R1,$ELHND-$RMON(R3)
1$:	RTS	PC
ERLCHK:
.IF NE	SYT$K
	CMP	#"EL,I.LNAM(R4)
	BNE	1$
	TSTB	I.LNAM+2(R4)
	BNE	1$
.IFF
	CMP	#<^REL >,I.NAME+2(R4)
.ENDC
1$:	RTS	PC
.ENDC
DEADJB:	MOV	SP,@<.EXTFL-OVLY>-<.+4-OVLYST>(PC)
	MOV	R2,R4
.IF NE	ERL$G
	JSR	PC,ERLCHK
	BNE	1$
	MOV	@#SYSPTR,R2
	CLR	$ELHND-$RMON(R2)
1$:
.ENDC
	CLR	@R5
	MOV	R3,-(SP)
	OJSR	PC,PUTBLK
	MOV	(SP)+,R3
	BCC	2$
	ADD	R0,R5SAV
	ADD	R0,@SP
	ADD	R0,2(SP)
2$:	CLR	@<.EXTFL-OVLY>-<.+4-OVLYST>(PC)
	RTS	PC
OVAFSP:	MOV	R5,(PC)+
R5SAV:	 .WORD	0
	RTS	PC
OVANAM:
.IF EQ	SYT$K
	BR	BDSWIT
.IFF
	CMPB	#':,@R5
	BNE	BDSWCH
	OADDR	FILST+OFLJN,R2
	MOV	R2,-(SP)
	MOV	#6,R3
1$:	OJSR	PC,ALPHNT
	BCC	BDNAM
	MOVB	@R5,(R2)+
	DEC	R3
	BEQ	2$
	TSTB	-(R5)
	BEQ	3$
	CMPB	#SLASH,@R5
	BEQ	3$
	CMPB	#SPACE,(R5)+
	BNE	1$
2$:	DEC	R5
3$:	MOV	(SP)+,R2
	CMP	#'F,@R2
	BEQ	BDNAM
	CMP	#'B,@R2
	BEQ	BDNAM
	RTS	PC
.ENDC
OVALEV:
.IF EQ	SYT$K
	BR	BDSWIT
.IFF
	CMP	#FJOBNM,JLVL
	BEQ	BDSWIT
	CMPB	#':,@R5
	BNE	BDSWCH
	JSR	PC,SWVAL
	TST	@SP
	BLE	BDLVL
	CMP	#MXJBNM,@SP
	BLE	BDLVL
	MOV	(SP)+,JLVL
	RTS	PC
.ENDC
OVABUF:	CMPB	#':,@R5
	BNE	BDSWCH
	JSR	PC,SWVAL
OINST	MOV	(SP)+,FILST+OFBUF,,*
	RTS	PC
OVAPAU:
OINST	INC	FILST+OFPSW,,*
	RTS	PC
OVATTY:
.IF NE	MTT$Y
	CMPB	#':,@R5
	BNE	BDSWCH
	JSR	PC,SWVAL
	CMP	@SP,#TCBMAX*2
	BGE	BDSWCH
	OADDR	FILST+OFTTY,R2
	MOV	(SP)+,@R2
	COM	@R2
	RTS	PC
.ENDC
BDSWCH:	OJMP	BADCOM
BDSWIT:	OJMP	ILSWIT
.IF NE	SYT$K
BDNAM:	JMP	BADNAM
BDLVL:	JMP	BADLVL
.ENDC
SWVAL:	MOV	@SP,-(SP)
	MOV	R5,-(SP)
	OJSR	PC,DECNUM
	DEC	R5
	CMPB	1(R5),#PERIOD
	BEQ	1$
	TST	(SP)+
	MOV	@SP,R5
	OJSR	PC,OCTNUM
1$:	MOV	(SP)+,@SP
	BCS	BDSWCH
	ASL	@SP
	MOV	(SP)+,2(SP)
	RTS	PC
	.IRP	NUM,<\$OPTX>
OPTX'NUM::
	.ENDR
	.BYTE	-1
	.DSABL	CRF
	$SCNT=0
	SWTDEF	<PAUSE>
	FLGTXT		<P_AUSE>
	SWTDEF	<TERMINAL>
	FLGTXT		<TE_RMINAL